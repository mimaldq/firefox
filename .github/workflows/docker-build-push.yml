name: æ„å»º Docker é•œåƒ

on:
  workflow_dispatch:
    inputs:
      custom_image_name:
        description: 'è‡ªå®šä¹‰çš„é•œåƒåç§°ï¼ˆä¾‹å¦‚ï¼šmyapp/firefox-novncï¼Œç•™ç©ºåˆ™é»˜è®¤ä¸ºfirefoxï¼‰'
        required: false  # ç”±äºæœ‰é»˜è®¤å€¼ï¼Œå¯ä»¥è®¾ä¸ºéå¿…éœ€
        default: 'firefox'  # å…³é”®ä¿®æ”¹ï¼šé»˜è®¤é•œåƒåè®¾ä¸º firefox

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ„å»ºå¹¶æ¨é€
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.custom_image_name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: è·å–å¹¶æ˜¾ç¤ºé•œåƒå¤§å°
        run: |
          # è®¾ç½®é•œåƒå®Œæ•´åç§°
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.custom_image_name }}:latest"
          
          echo "ğŸ“Š æ­£åœ¨è·å–é•œåƒå¤§å°ä¿¡æ¯..."
          
          # æ‹‰å–é•œåƒåˆ°æœ¬åœ°ä»¥ä¾¿æ£€æŸ¥å¤§å°
          docker pull $IMAGE_NAME
          
          # è·å–é•œåƒè¯¦ç»†ä¿¡æ¯
          IMAGE_INFO=$(docker image inspect $IMAGE_NAME --format='{{.Size}} {{.Created}} {{.Os}}/{{.Architecture}}')
          
          # è§£æä¿¡æ¯
          SIZE_BYTES=$(echo $IMAGE_INFO | cut -d' ' -f1)
          CREATED=$(echo $IMAGE_INFO | cut -d' ' -f2 | sed 's/T/ /' | cut -d'.' -f1)
          PLATFORM=$(echo $IMAGE_INFO | cut -d' ' -f3)
          
          # è®¡ç®—ä¸åŒå•ä½çš„å¤§å°
          SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1024 / 1024" | bc)
          SIZE_GB=$(echo "scale=2; $SIZE_BYTES / 1024 / 1024 / 1024" | bc)
          
          # è·å–é•œåƒå±‚æ•°
          LAYERS=$(docker image inspect $IMAGE_NAME --format='{{.RootFS.Layers}}' | tr ',' '\n' | wc -l)
          
          # è·å–é•œåƒæ ‡ç­¾
          REPO_TAGS=$(docker image inspect $IMAGE_NAME --format='{{.RepoTags}}')
          
          echo "========================================"
          echo "ğŸ“¦ é•œåƒè¯¦ç»†ä¿¡æ¯"
          echo "========================================"
          echo "ğŸ“› é•œåƒåç§°: $REPO_TAGS"
          echo "ğŸ–¥ï¸  å¹³å°æ¶æ„: $PLATFORM"
          echo "ğŸ“ é•œåƒå¤§å°:"
          echo "   - $SIZE_BYTES å­—èŠ‚"
          echo "   - $SIZE_MB MB"
          echo "   - $SIZE_GB GB"
          echo "ğŸ“… åˆ›å»ºæ—¶é—´: $CREATED"
          echo "ğŸ”¢ é•œåƒå±‚æ•°: $LAYERS å±‚"
          echo "========================================"
          
          # å¯é€‰ï¼šæ˜¾ç¤ºæ¯ä¸ªå±‚çš„å¤§å°ï¼ˆè¯¦ç»†åˆ†æï¼‰
          echo "ğŸ” é•œåƒå±‚è¯¦ç»†åˆ†æ:"
          docker history $IMAGE_NAME --no-trunc --format "table {{.CreatedBy}}\t{{.Size}}" | head -20
          
          echo ""
          echo "âœ… é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo "ğŸ“¥ æ‹‰å–å‘½ä»¤ï¼šdocker pull $IMAGE_NAME"

      - name: éªŒè¯é•œåƒåŠŸèƒ½
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.custom_image_name }}:latest"
          
          echo "ğŸ”¬ éªŒè¯é•œåƒåŸºæœ¬åŠŸèƒ½..."
          
          # æµ‹è¯•è¿è¡Œå®¹å™¨ï¼Œæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
          docker run --rm $IMAGE_NAME echo "âœ… é•œåƒåŸºæœ¬åŠŸèƒ½æ­£å¸¸"
          
          # æ£€æŸ¥é•œåƒä¸­çš„å…³é”®æ–‡ä»¶
          docker run --rm $IMAGE_NAME ls -la /usr/local/bin/start.sh
          docker run --rm $IMAGE_NAME ls -la /opt/novnc/
          
          echo "âœ… é•œåƒéªŒè¯å®Œæˆ"
